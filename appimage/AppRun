#!/bin/bash
# AppRun - Entry point for Linux STT AppImage
# Version: 1.0.0
# Created: 2025-12-12
#
# This script is executed when the AppImage is run.
# It sets up the environment, handles installation, and launches the application.
#
# Features:
# - Environment setup (PATH, LD_LIBRARY_PATH, PYTHONHOME, PYTHONPATH)
# - Bundled model path configuration via LINUX_STT_MODEL_PATH
# - Portable installation to ~/.local/bin with --install flag
# - Permission setup and systemd service configuration

set -e

# Get AppImage directory (where AppImage is mounted)
APPDIR="$(dirname "$(readlink -f "$0")")"

# Set up environment for bundled Python and libraries
export PATH="$APPDIR/usr/bin:$PATH"
export LD_LIBRARY_PATH="$APPDIR/usr/lib:$LD_LIBRARY_PATH"
export PYTHONHOME="$APPDIR/usr"
export PYTHONPATH="$APPDIR/usr/lib/python3.11/site-packages:$PYTHONPATH"

# Set model path to bundled SenseVoice model
# ModelScope downloads to: models/iic/SenseVoiceSmall
export LINUX_STT_MODEL_PATH="$APPDIR/usr/share/linux-stt/models/iic/SenseVoiceSmall"

# Handle --install flag for portable USB installation
if [ "$1" = "--install" ]; then
    echo "Installing Linux STT..."
    echo ""

    # Check if running from AppImage
    if [ -z "$APPIMAGE" ]; then
        echo "Error: --install must be run from the AppImage"
        echo "Usage: ./linux-stt-x86_64.AppImage --install"
        exit 1
    fi

    # Create installation directory
    INSTALL_DIR="$HOME/.local/bin"
    mkdir -p "$INSTALL_DIR"

    # Copy AppImage to installation directory
    INSTALL_PATH="$INSTALL_DIR/linux-stt.AppImage"
    echo "Copying AppImage to $INSTALL_PATH..."
    cp "$APPIMAGE" "$INSTALL_PATH"
    chmod +x "$INSTALL_PATH"

    # Create symlink for easy access
    SYMLINK_PATH="$INSTALL_DIR/linux-stt"
    echo "Creating symlink at $SYMLINK_PATH..."
    ln -sf "$INSTALL_PATH" "$SYMLINK_PATH"

    # Setup input group permissions
    echo ""
    echo "Setting up permissions..."
    if ! groups | grep -q input; then
        echo "Adding user to 'input' group for keyboard access..."
        echo "This requires your password:"
        sudo usermod -a -G input "$USER"
        NEED_LOGOUT=1
    else
        echo "User already in 'input' group."
        NEED_LOGOUT=0
    fi

    # Setup udev rules for evdev access
    UDEV_RULES_FILE="/etc/udev/rules.d/99-linux-stt.rules"
    if [ ! -f "$UDEV_RULES_FILE" ]; then
        echo ""
        echo "Setting up udev rules for keyboard access..."
        echo "This requires your password:"
        sudo bash -c "cat > $UDEV_RULES_FILE" <<'EOF'
# Linux STT udev rules
# Allow members of input group to access event devices
KERNEL=="event*", MODE="0660", GROUP="input"
EOF
        sudo udevadm control --reload-rules
        sudo udevadm trigger
        echo "udev rules installed."
    else
        echo "udev rules already installed."
    fi

    # Setup systemd user service
    SYSTEMD_DIR="$HOME/.config/systemd/user"
    SERVICE_FILE="$SYSTEMD_DIR/linux-stt.service"
    mkdir -p "$SYSTEMD_DIR"

    echo ""
    echo "Creating systemd service..."
    cat > "$SERVICE_FILE" <<EOF
[Unit]
Description=Linux STT - Push-to-talk Speech-to-Text
After=graphical.target

[Service]
Type=simple
ExecStart=$INSTALL_PATH --daemon
Restart=on-failure
RestartSec=5
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=default.target
EOF

    # Reload systemd
    systemctl --user daemon-reload

    echo ""
    echo "Installation complete!"
    echo ""
    echo "Next steps:"
    echo ""

    if [ "$NEED_LOGOUT" = "1" ]; then
        echo "1. Log out and log back in to apply group permissions"
        echo ""
    fi

    echo "To start Linux STT:"
    echo "  systemctl --user start linux-stt"
    echo ""
    echo "To enable automatic startup:"
    echo "  systemctl --user enable linux-stt"
    echo ""
    echo "To check status:"
    echo "  systemctl --user status linux-stt"
    echo ""
    echo "To view logs:"
    echo "  journalctl --user -u linux-stt -f"
    echo ""
    echo "Installed to: $INSTALL_PATH"

    exit 0
fi

# Handle --help flag
if [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
    echo "Linux STT AppImage"
    echo ""
    echo "Usage:"
    echo "  ./linux-stt-x86_64.AppImage [OPTIONS]"
    echo ""
    echo "Options:"
    echo "  --install              Install to ~/.local/bin and setup systemd service"
    echo "  --help, -h             Show this help message"
    echo "  --version              Show version information"
    echo ""
    echo "All other options are passed to linux-stt:"
    "$APPDIR/usr/bin/python3" -m linux_stt.main --help
    exit 0
fi

# Handle --version flag
if [ "$1" = "--version" ]; then
    echo "Linux STT AppImage v1.0.0"
    "$APPDIR/usr/bin/python3" -m linux_stt.main --version
    exit 0
fi

# Run the application with all arguments passed through
exec "$APPDIR/usr/bin/python3" -m linux_stt.main "$@"
