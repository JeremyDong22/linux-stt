#!/bin/bash
# AppRun - Entry point for Linux STT AppImage
# Version: 1.1.0
# Updated: 2025-12-13
#
# This script is executed when the AppImage is run.
# Auto-installs on first run, then launches the application.
#
# Features:
# - Auto-install on first run (copies to ~/.local/bin)
# - Environment setup (PATH, LD_LIBRARY_PATH, PYTHONHOME, PYTHONPATH)
# - Bundled model path configuration via LINUX_STT_MODEL_PATH
# - Permission setup and systemd service configuration
# - Use --portable to run without installing

set -e

# Get AppImage directory (where AppImage is mounted)
APPDIR="$(dirname "$(readlink -f "$0")")"

# Installation paths - install to ~/smartice
INSTALL_DIR="$HOME/smartice"
INSTALL_PATH="$INSTALL_DIR/linux-stt.AppImage"

# Set up environment for bundled Python and libraries
export PATH="$APPDIR/usr/bin:$PATH"
export LD_LIBRARY_PATH="$APPDIR/usr/lib:$LD_LIBRARY_PATH"
export PYTHONHOME="$APPDIR/usr"
export PYTHONPATH="$APPDIR/usr/lib/python3.11/site-packages:$PYTHONPATH"

# Set model path to bundled SenseVoice model
export LINUX_STT_MODEL_PATH="$APPDIR/usr/share/linux-stt/models/iic/SenseVoiceSmall"

# Function to perform installation
do_install() {
    echo "Installing Linux STT..."
    echo ""

    # Check if running from AppImage
    if [ -z "$APPIMAGE" ]; then
        echo "Error: Cannot install - not running from AppImage"
        return 1
    fi

    # Create installation directory
    mkdir -p "$INSTALL_DIR"

    # Copy AppImage to installation directory
    echo "Copying AppImage to $INSTALL_PATH..."
    cp "$APPIMAGE" "$INSTALL_PATH"
    chmod +x "$INSTALL_PATH"

    # Create symlink for easy access in ~/smartice
    SYMLINK_PATH="$INSTALL_DIR/linux-stt"
    echo "Creating symlink at $SYMLINK_PATH..."
    ln -sf "$INSTALL_PATH" "$SYMLINK_PATH"

    # Also add to ~/.local/bin for PATH access
    mkdir -p "$HOME/.local/bin"
    ln -sf "$INSTALL_PATH" "$HOME/.local/bin/linux-stt"

    # Setup input group permissions
    echo ""
    echo "Setting up permissions..."
    if ! groups | grep -q input; then
        echo "Adding user to 'input' group for keyboard access..."
        echo "This requires your password:"
        sudo usermod -a -G input "$USER"
        NEED_LOGOUT=1
    else
        echo "User already in 'input' group."
        NEED_LOGOUT=0
    fi

    # Setup udev rules for evdev access
    UDEV_RULES_FILE="/etc/udev/rules.d/99-linux-stt.rules"
    if [ ! -f "$UDEV_RULES_FILE" ]; then
        echo ""
        echo "Setting up udev rules for keyboard access..."
        echo "This requires your password:"
        sudo bash -c "cat > $UDEV_RULES_FILE" <<'EOF'
# Linux STT udev rules
# Allow members of input group to access event devices
KERNEL=="event*", MODE="0660", GROUP="input"
EOF
        sudo udevadm control --reload-rules
        sudo udevadm trigger
        echo "udev rules installed."
    else
        echo "udev rules already installed."
    fi

    # Setup systemd user service
    SYSTEMD_DIR="$HOME/.config/systemd/user"
    SERVICE_FILE="$SYSTEMD_DIR/linux-stt.service"
    mkdir -p "$SYSTEMD_DIR"

    echo ""
    echo "Creating systemd service..."
    cat > "$SERVICE_FILE" <<EOF
[Unit]
Description=Linux STT - Push-to-talk Speech-to-Text
After=graphical.target

[Service]
Type=simple
ExecStart=$INSTALL_PATH --daemon
Restart=on-failure
RestartSec=5
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=default.target
EOF

    # Reload systemd
    systemctl --user daemon-reload

    # Enable service for auto-start
    systemctl --user enable linux-stt 2>/dev/null || true

    echo ""
    echo "========================================="
    echo "Installation complete!"
    echo "========================================="
    echo ""
    echo "Installed to: $INSTALL_PATH"
    echo ""

    if [ "$NEED_LOGOUT" = "1" ]; then
        echo "IMPORTANT: Log out and log back in to apply group permissions,"
        echo "then run: systemctl --user start linux-stt"
    else
        echo "Starting Linux STT service..."
        systemctl --user start linux-stt || true
        echo ""
        echo "Service started! Hold Ctrl to speak, release to transcribe."
        echo ""
        echo "Commands:"
        echo "  systemctl --user status linux-stt   # Check status"
        echo "  systemctl --user stop linux-stt     # Stop service"
        echo "  journalctl --user -u linux-stt -f   # View logs"
    fi
    echo ""
}

# Check if already installed
is_installed() {
    [ -f "$INSTALL_PATH" ]
}

# Handle --portable flag (run without installing)
if [ "$1" = "--portable" ]; then
    shift
    exec "$APPDIR/usr/bin/python3" -m linux_stt.main "$@"
fi

# Handle --install flag (force reinstall)
if [ "$1" = "--install" ]; then
    do_install
    exit 0
fi

# Handle --help flag
if [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
    echo "Linux STT AppImage"
    echo ""
    echo "Usage:"
    echo "  ./linux-stt-x86_64.AppImage [OPTIONS]"
    echo ""
    echo "Options:"
    echo "  --install              Force reinstall to ~/.local/bin"
    echo "  --portable             Run without installing (temporary)"
    echo "  --help, -h             Show this help message"
    echo "  --version              Show version information"
    echo ""
    echo "Default behavior: Auto-installs on first run, then starts service."
    echo ""
    echo "All other options are passed to linux-stt:"
    "$APPDIR/usr/bin/python3" -m linux_stt.main --help
    exit 0
fi

# Handle --version flag
if [ "$1" = "--version" ]; then
    echo "Linux STT AppImage v1.1.0"
    "$APPDIR/usr/bin/python3" -m linux_stt.main --version
    exit 0
fi

# Auto-install on first run if not already installed
if ! is_installed; then
    echo "First run detected - installing Linux STT..."
    echo ""
    do_install
    exit 0
fi

# Already installed - run the application
exec "$APPDIR/usr/bin/python3" -m linux_stt.main "$@"
